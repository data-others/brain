name: Update release notes

on:
  workflow_dispatch:

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed so we can push changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install python dependencies
        run: pip install requests

      - name: Generate [tag].md files for all releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python << 'PY'
          import os, requests, pathlib

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ.get("GITHUB_TOKEN", "")

          headers = {"Accept": "application/vnd.github+json"}
          if token:
              headers["Authorization"] = f"Bearer {token}"

          releases = []
          url = f"https://api.github.com/repos/{repo}/releases?per_page=100"
          while url:
              resp = requests.get(url, headers=headers)
              resp.raise_for_status()
              releases.extend(resp.json())
              url = resp.links.get("next", {}).get("url")

          for rel in releases:
              tag = rel.get("tag_name") or "untagged"
              body = rel.get("body") or ""
              fn = pathlib.Path(f"{tag}.md")
              fn.write_text(body, encoding="utf-8")

          PY

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add *.md || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update release notes from GitHub releases"
          git push
